<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íŠ¹ê·¼ ì¶œì„ ê´€ë¦¬(í…ŒìŠ¤íŠ¸ì¤‘)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary-green: #0a8a43;
      --primary-blue: #007aff;
      --bg-gray: #f5f5f7;
      --border-gray: #dddddd;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: var(--bg-gray);
      color: #222;
    }

    .header {
      background: #111;
      color: #fff;
      padding: 14px 12px 10px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    .header-sub {
      font-size: 13px;
      color: #ddd;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 14px 18px;
    }

    h2 {
      font-size: 16px;
      margin: 16px 0 8px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.04);
      border: 1px solid var(--border-gray);
    }

    /* ê´€ë¦¬ì ì¹´ë“œ ì—°ë…¸ë‘ */
    .card.admin-card {
      background: #fffbe6;
      border-color: #f0e0a0;
    }

    /* ğŸ“Œ 3ë²ˆ ì¹´ë“œì™€ ë™ì¼í•œ ë””ìì¸ ì…ë ¥ë°•ìŠ¤ */
    .admin-input {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 12px;
      background: #f8f8f8;
      color: #222;
      box-sizing: border-box;
    }

    /* ì›” ì„ íƒ wrapper */
    .month-select-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      margin: 8px 0 10px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      display: inline-block;
    }

    input[type="date"],
    select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin-bottom: 6px;
      max-width: 100%;
      box-sizing: border-box;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 14px;
      color: #fff;
      background: var(--primary-green);
      margin-top: 6px;
      display: inline-block;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-secondary {
      background: var(--primary-blue);
    }

    .info {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .warning {
      font-size: 13px;
      color: #c00;
      margin-top: 4px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1 1 120px;
      min-width: 0;
    }

    .status-group {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #fafafa;
      border: 1px solid #eee;
    }

    .status-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .status-options {
      font-size: 13px;
    }

    .status-options label {
      font-weight: 400;
      margin-right: 12px;
      display: inline-flex;
      align-items: center;
    }

    .status-options input[type="radio"] {
      margin-right: 3px;
    }

    .summary-block {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #fafafa;
      border: 1px solid #eee;
      font-size: 13px;
      line-height: 1.5;
      display: none;
    }

    .summary-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .chip-wrap {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f0f0f0;
    }

    .chip button {
      border: none;
      background: none;
      margin-left: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      .admin-input {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-title">íŠ¹ê·¼ ì¶œì„ ê´€ë¦¬(í…ŒìŠ¤íŠ¸ì¤‘)</div>
    <div class="header-sub">íŠ¸ë¦¼2ë°˜ Â· í† ìš”ì¼ íŠ¹ê·¼ ì¡°ì‚¬</div>
  </header>

  <div class="container">

    <!-- 1ï¸âƒ£ íŠ¹ê·¼ ì›” ì„ íƒ -->
    <div class="card">
      <h2>íŠ¹ê·¼ ì›” ì„ íƒ</h2>
      <label for="monthSelect">íŠ¹ê·¼ ì›”</label>
      <div class="month-select-wrap">
        <select id="monthSelect" class="admin-input"></select>
      </div>
      <div class="info">
        ì´ ë‹¬ì— ë“±ë¡ëœ íŠ¹ê·¼ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ<br/>
        ì•„ë˜ â‘  ì°¸ì—¬ì²´í¬, â‘¡ ì¡°ë³„/ì „ì²´í˜„í™©ì´ ìë™ ë°˜ì˜ë©ë‹ˆë‹¤.
      </div>
    </div>

        <!-- 2ï¸âƒ£ ê°œì¸ íŠ¹ê·¼ ì°¸ì—¬ ì²´í¬ -->
    <div class="card">
      <h2>â‘  íŠ¹ê·¼ ì°¸ì—¬ ì²´í¬</h2>

      <label for="personSelect">ì´ë¦„ ì„ íƒ</label>
      <select id="personSelect" class="admin-input"></select>

      <div class="status-group">
        <div class="status-title">ì´ë²ˆì£¼ í† ìš”ì¼ íŠ¹ê·¼ ì°¸ì—¬ì—¬ë¶€</div>
        <div class="status-options">
          <label><input type="radio" name="status" value="ì°¸ì„"> ì°¸ì„</label>
          <label><input type="radio" name="status" value="ë¶ˆì°¸"> ë¶ˆì°¸</label>
          <label><input type="radio" name="status" value="ë¯¸ì‘ë‹µ"> ë¯¸ì‘ë‹µ</label>
        </div>
      </div>

      <button class="btn" id="saveStatusBtn">ì €ì¥í•˜ê¸°</button>
      <div id="saveStatusMsg" class="info"></div>
    </div>


    <!-- 3ï¸âƒ£ ì¡°ë³„ / ì „ì²´ í˜„í™© ì¡°íšŒ -->
    <div class="card admin-card">
      <h2>â‘¡ ì¡°ë³„ / ì „ì²´ íŠ¹ê·¼ í˜„í™© ì¡°íšŒ</h2>

      <label for="teamSelect">ì¡°íšŒ êµ¬ë¶„</label>
      <select id="teamSelect" class="admin-input">
        <option value="all">ì „ì²´</option>
        <option value="1">1ì¡° (ì¡°ì¥: ì¢…ëª…)</option>
        <option value="2">2ì¡° (ì¡°ì¥: ì •í˜„)</option>
        <option value="3">3ì¡° (ì¡°ì¥: í˜•ì›)</option>
      </select>

      <button class="btn-secondary btn" id="viewStatusBtn">í˜„í™© ë³´ê¸°</button>

      <div id="summaryBlock" class="summary-block">
        <div class="summary-title">ğŸ“Œ íŠ¹ê·¼ í˜„í™© ìš”ì•½</div>
        <div id="summaryText"></div>

        <div class="summary-title" style="margin-top:6px;">ì°¸ì„</div>
        <div id="listAttend" class="chip-wrap"></div>

        <div class="summary-title" style="margin-top:6px;">ë¶ˆì°¸</div>
        <div id="listAbsent" class="chip-wrap"></div>

        <div class="summary-title" style="margin-top:6px;">ë¯¸ì‘ë‹µ</div>
        <div id="listUnknown" class="chip-wrap"></div>
      </div>
    </div>


    <!-- 4ï¸âƒ£ ê´€ë¦¬ììš© íŠ¹ê·¼ ë‚ ì§œ ë“±ë¡ -->
    <div class="card admin-card">
      <h2>â‘¢ ê´€ë¦¬ììš© Â· íŠ¹ê·¼ ë‚ ì§œ ë“±ë¡</h2>

      <label for="adminDateInput">íŠ¹ê·¼ ë‚ ì§œ ì§€ì •</label>
      <input id="adminDateInput" type="date" class="admin-input">

      <button class="btn-secondary btn" id="addDateBtn">íŠ¹ê·¼ ë‚ ì§œ ì¶”ê°€</button>

      <div class="info" style="margin-top:6px;">
        ë“±ë¡ëœ ë‚ ì§œë“¤ì€ ìë™ìœ¼ë¡œ ì›”ë³„ ê´€ë¦¬ë˜ë©°<br/>
        â‘  ì°¸ì—¬ ì²´í¬ ë° â‘¡ í˜„í™© ì¡°íšŒì— ë°˜ì˜ë©ë‹ˆë‹¤.
      </div>

      <div id="savedDateList" class="chip-wrap" style="margin-top:10px;"></div>
    </div>

  </div> <!-- container ë -->

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc } 
      from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCeeyyh0hxJUZZC5lvUH52iSCteNhzgbSI",
      authDomain: "survey-87173.firebaseapp.com",
      projectId: "survey-87173",
      storageBucket: "survey-87173.firebasestorage.app",
      messagingSenderId: "854671970902",
      appId: "1:854671970902:web:74a0d89a4182e7a09321f7",
      measurementId: "G-P5G2KDCGM0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* -----------------------------------------------
       ê¸°ë³¸ ë°ì´í„°
    ----------------------------------------------- */
    const team1 = ["ì„±í•´","ì¶©í›ˆ","ì„±ì²œ","ì˜¥ì—°","í•™í˜„","ìš©ë‚¨","ì„œì§„","ìš°ë¹ˆ","ê¸°ë°±"];
    const team2 = ["ì„±í›ˆ","ì¢…ìµ","ì›…ê¸°","ë¯¼êµ­","ì§„ì†”","ê°‘ìˆ˜","ìƒê±´","ì›ë¹ˆ","ëŒ€í˜„","ìŠ¹í˜¸"];
    const team3 = ["ì¬ê¶Œ","ì œë•","ì •ë¬´","ê¸¸ìš´","ë²”ì„±","ì´ìŠ¬","ì˜í™˜","ìˆ˜ì‹ ","ì‘ê·œ","ë¯¼êµ­","ìš©ì„­","ì˜¤ì±„"];

    const allMembers = [...team1, ...team2, ...team3];
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>íŠ¹ê·¼ ì¶œì„ ê´€ë¦¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary-green: #0a8a43;
      --primary-blue: #007aff;
      --bg-gray: #f5f5f7;
      --border-gray: #dddddd;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: var(--bg-gray);
      color: #222;
    }

    .header {
      background: #111;
      color: #fff;
      padding: 14px 12px 10px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-title {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 4px;
    }
    .header-sub {
      font-size: 13px;
      color: #ddd;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px 14px 18px;
    }

    h2 {
      font-size: 16px;
      margin: 16px 0 8px;
    }

    .card {
      background: #fff;
      border-radius: 14px;
      padding: 12px 14px;
      margin-bottom: 14px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.04);
      border: 1px solid var(--border-gray);
    }

    /* ê´€ë¦¬ììš© ì¹´ë“œ: ì—°ë…¸ë‘ */
    .card.admin-card {
      background: #fffbe6;
      border-color: #f0e0a0;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
      display: inline-block;
    }

    /* ê¸°ë³¸ ì¸í’‹ ìŠ¤íƒ€ì¼ */
    input[type="date"],
    input[type="month"],
    select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      margin-bottom: 6px;
      max-width: 100%;
      box-sizing: border-box;
      width: 100%;
      background: #fff;
    }

    /* ğŸ“Œ 1ë²ˆ ì›”ì„ íƒ & 3ë²ˆ ë‚ ì§œ ì¸í’‹ ê³µí†µ(ëª¨ì–‘ í†µì¼) */
    .admin-input {
      padding: 10px 12px;
      font-size: 16px;
      border-radius: 12px;
      background: #f8f8f8;
      border: 1px solid #ccc;
      text-align: center;
    }

    /* 1ë²ˆ ì¹´ë“œ ì›” ì„ íƒ ë°•ìŠ¤ë¥¼ ê°€ìš´ë° ì •ë ¬ */
    .month-select-wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      margin: 8px 0 10px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 9px 16px;
      font-size: 14px;
      color: #fff;
      background: var(--primary-green);
      margin-top: 6px;
      display: inline-block;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-secondary {
      background: var(--primary-blue);
    }

    .info {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    .warning {
      font-size: 13px;
      color: #c00;
      margin-top: 4px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row > div {
      flex: 1 1 120px;
      min-width: 0;
    }

    .status-group {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #fafafa;
      border: 1px solid #eee;
    }

    .status-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .status-options {
      font-size: 13px;
    }

    .status-options label {
      font-weight: 400;
      margin-right: 12px;
      display: inline-flex;
      align-items: center;
    }

    .status-options input[type="radio"] {
      margin-right: 3px;
    }

    .summary-block {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #fafafa;
      border: 1px solid #eee;
      font-size: 13px;
      line-height: 1.5;
      display: none;
    }

    .summary-title {
      font-weight: 700;
      margin-bottom: 4px;
    }

    .list-names {
      font-size: 13px;
      margin-top: 2px;
    }

    .list-names.empty {
      color: #999;
    }

    .back-link {
      text-align: center;
      margin-top: 8px;
      font-size: 13px;
    }

    .back-link a {
      color: var(--primary-blue);
      text-decoration: none;
    }

    .chip-wrap {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #f0f0f0;
    }

    .chip button {
      border: none;
      background: none;
      margin-left: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      .container {
        padding: 10px;
      }
      .admin-input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-title">íŠ¹ê·¼ ì¶œì„ ê´€ë¦¬</div>
    <div class="header-sub">íŠ¸ë¦¼2ë°˜ Â· í† ìš”ì¼ íŠ¹ê·¼ Â· ì›”ë³„ ê´€ë¦¬</div>
  </header>

  <div class="container">
    <!-- 1ï¸âƒ£ íŠ¹ê·¼ ì›” ì„ íƒ -->
    <div class="card">
      <h2>íŠ¹ê·¼ ì›” ì„ íƒ</h2>
      <label for="monthSelect">íŠ¹ê·¼ ì›”</label>
      <div class="month-select-wrap">
        <input type="month" id="monthSelect" class="admin-input" />
      </div>
      <div class="info">
        ì´ ì›”ì— ì„¤ì •ëœ íŠ¹ê·¼ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ<br/>
        ì•„ë˜ <b>â‘  ë‚´ ì°¸ì—¬ ì²´í¬</b>ì™€ <b>â‘¡ ì¡°ë³„/ì „ì²´ í˜„í™©</b>ì´ í•¨ê»˜ ë°”ë€ë‹ˆë‹¤.
      </div>
    </div>

    <!-- â‘  ê°œì¸ íŠ¹ê·¼ ì°¸ì—¬ ì²´í¬ -->
    <div class="card">
      <h2>â‘  ë‚´ íŠ¹ê·¼ ì°¸ì—¬ ì²´í¬</h2>
      <label for="personSelect">ì´ë¦„</label>
      <select id="personSelect">
        <option value="">ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</option>
      </select>

      <div id="personStatusArea">
        <!-- ì„ íƒëœ ì›” & ì´ë¦„ ê¸°ì¤€ìœ¼ë¡œ ë‚ ì§œë³„ ì°¸ì—¬ì—¬ë¶€ UI ìƒì„± -->
      </div>

      <button class="btn" id="savePersonBtn">ë‚´ íŠ¹ê·¼ ì°¸ì—¬ì—¬ë¶€ ì €ì¥</button>
      <div id="personMsg" class="info"></div>
    </div>

    <!-- â‘¡ ì¡°ë³„ / ì „ì²´ í˜„í™© ì¡°íšŒ -->
    <div class="card">
      <h2>â‘¡ ì¡°ë³„ / ì „ì²´ í˜„í™© ì¡°íšŒ</h2>
      <div class="row">
        <div>
          <label for="summaryDateSelect">íŠ¹ê·¼ ë‚ ì§œ</label>
          <select id="summaryDateSelect">
            <!-- ì›” ì„ íƒì— ë”°ë¼ ì±„ì›Œì§ -->
          </select>
        </div>
        <div>
          <label for="summaryGroupSelect">ì¡°íšŒ ëŒ€ìƒ</label>
          <select id="summaryGroupSelect">
            <option value="all">ì „ì²´</option>
            <option value="1ì¡°">1ì¡°</option>
            <option value="2ì¡°">2ì¡°</option>
            <option value="3ì¡°">3ì¡°</option>
          </select>
        </div>
      </div>
      <button class="btn btn-secondary" id="summaryBtn">ì¡°íšŒ</button>

      <div id="summaryResult" class="summary-block"></div>
    </div>

    <!-- â‘¢ ê´€ë¦¬ììš©: ì›”ë³„ íŠ¹ê·¼ ë‚ ì§œ ì„¤ì • (ì—°ë…¸ë‘ ì¹´ë“œ) -->
    <div class="card admin-card">
      <h2>â‘¢ ê´€ë¦¬ììš© â€“ ì›”ë³„ íŠ¹ê·¼ ë‚ ì§œ ì„¤ì •</h2>
      <div class="info">
        ì„ íƒëœ ì›”ì— ëŒ€í•´ <b>íŠ¹ê·¼ ë‚ ì§œ</b>ë¥¼ ë“±ë¡/ì‚­ì œí•©ë‹ˆë‹¤.<br/>
        ê¸°ë³¸ìœ¼ë¡œ í† ìš”ì¼ ë‚ ì§œë¥¼ ìë™ ì œì•ˆí•  ìˆ˜ë„ ìˆê³ , ëª…ì ˆ/ê³µíœ´ì¼ ë“±ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>

      <div id="currentMonthLabel" class="info" style="margin-top:6px;"></div>

      <div style="margin-top:8px;">
        <label>ë“±ë¡ëœ íŠ¹ê·¼ ë‚ ì§œ</label>
        <div id="dateListArea" class="info">
          <!-- chip ëª©ë¡ -->
        </div>
      </div>

      <div style="margin-top:8px;">
        <label for="newDateInput">íŠ¹ê·¼ ë‚ ì§œ ì¶”ê°€</label>
        <input type="date" id="newDateInput" class="admin-input" />
        <button class="btn btn-secondary" id="addDateBtn">ë‚ ì§œ ì¶”ê°€</button>
      </div>

      <!-- ì´ ì›” í† ìš”ì¼ ìë™ ì œì•ˆ ë²„íŠ¼ -->
      <div style="margin-top:8px;">
        <button class="btn btn-secondary" id="autoSatBtn">
          ì´ ì›” í† ìš”ì¼ ìë™ ì œì•ˆ
        </button>
        <div class="info">
          ê¸°ì¡´ì— ë“±ë¡ëœ ë‚ ì§œëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ ,<br/>
          ì„ íƒí•œ ì›”ì˜ ëª¨ë“  í† ìš”ì¼ì„ ìë™ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.
        </div>
      </div>

      <button class="btn" id="saveDatesBtn" style="margin-top:10px;">ì´ ì›”ì˜ íŠ¹ê·¼ ì„¤ì • ì €ì¥</button>
      <div id="dateMsg" class="info"></div>
    </div>

    <div class="back-link">
      <a href="index.html">â† ì‘ì—… ìŠ¤ì¼€ì¤„ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

  <script>
    // ===== Firebase ì´ˆê¸°í™” =====
    const firebaseConfig = {
      apiKey: "AIzaSyCeeyyh0hxJUZZC5lvUH52iSCteNhzgbSI",
      authDomain: "survey-87173.firebaseapp.com",
      projectId: "survey-87173",
      storageBucket: "survey-87173.firebasestorage.app",
      messagingSenderId: "854671970902",
      appId: "1:854671970902:web:74a0d89a4182e7a09321f7",
      measurementId: "G-P5G2KDCGM0"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    if (firebase.analytics) {
      try { firebase.analytics(); } catch(e) {}
    }

    const DATES_COL = "ot_dates";
    const ATT_COL   = "ot_attendance";

    const weekdayNames = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];

    // ===== ì¸ì› / ì¡° í¸ì„± =====
    const people = [
      // 1ì¡°
      { name: "ì„±í•´", group: "1ì¡°" },
      { name: "ì¶©í›ˆ", group: "1ì¡°" },
      { name: "ì„±ì²œ", group: "1ì¡°" },
      { name: "ì˜¥ì—°", group: "1ì¡°" },
      { name: "í•™í˜„", group: "1ì¡°" },
      { name: "ìš©ë‚¨", group: "1ì¡°" },
      { name: "ì„œì§„", group: "1ì¡°" },
      { name: "ìš°ë¹ˆ", group: "1ì¡°" },
      { name: "ê¸°ë°±", group: "1ì¡°" },
      { name: "ì¢…ëª…", group: "1ì¡°" }, // 1ì¡° ì¡°ì¥

      // 2ì¡°
      { name: "ì„±í›ˆ", group: "2ì¡°" },
      { name: "ì¢…ìµ", group: "2ì¡°" },
      { name: "ì›…ê¸°", group: "2ì¡°" },
      { name: "ë¯¼ê·¼", group: "2ì¡°" },
      { name: "ì§„ì†”", group: "2ì¡°" },
      { name: "ê°‘ìˆ˜", group: "2ì¡°" },
      { name: "ìƒê±´", group: "2ì¡°" },
      { name: "ì›ë¹ˆ", group: "2ì¡°" },
      { name: "ëŒ€í˜„", group: "2ì¡°" },
      { name: "ìŠ¹í˜¸", group: "2ì¡°" },  // ì¶”ê°€
      { name: "ì •í˜„", group: "2ì¡°" }, // 2ì¡° ì¡°ì¥

      // 3ì¡°
      { name: "ì¬ê¶Œ", group: "3ì¡°" },
      { name: "ì œë•", group: "3ì¡°" },
      { name: "ì •ë¬´", group: "3ì¡°" },
      { name: "ê¸¸ìš´", group: "3ì¡°" },
      { name: "ë²”ì„±", group: "3ì¡°" },
      { name: "ì´ìŠ¬", group: "3ì¡°" },
      { name: "ì˜í™˜", group: "3ì¡°" },
      { name: "ìˆ˜ì‹ ", group: "3ì¡°" },
      { name: "ì‘ê·œ", group: "3ì¡°" },
      { name: "ë¯¼êµ­", group: "3ì¡°" },
      { name: "ìš©ì„­", group: "3ì¡°" },
      { name: "ì˜¤ì±„", group: "3ì¡°" },
      { name: "í˜•ì›", group: "3ì¡°" } // 3ì¡° ì¡°ì¥
    ];

    // ===== ê³µí†µ ìœ í‹¸ =====
    function pad2(n){ return n.toString().padStart(2,"0"); }

    function formatKoreanWeekday(dateStr){
      const d = new Date(dateStr);
      if(isNaN(d)) return "";
      return "("+weekdayNames[d.getDay()]+")";
    }

    function formatDisplayDate(dateStr){
      const d = new Date(dateStr);
      if(isNaN(d)) return dateStr;
      return `${pad2(d.getMonth()+1)}/${pad2(d.getDate())}${formatKoreanWeekday(dateStr)}`;
    }

    function getCurrentMonthValue(){
      return document.getElementById("monthSelect").value; // "YYYY-MM"
    }

    function findGroupByName(name){
      const p = people.find(p=>p.name===name);
      return p ? p.group : "";
    }

    // í˜„ì¬ ì›”ì˜ ë‚ ì§œ ëª©ë¡ ìºì‹œ
    let currentMonthDates = [];

    // ===== Firestore ì—°ë™ í•¨ìˆ˜ =====
    async function loadDatesForMonth(monthKey){
      if(!monthKey) return [];
      const docRef = db.collection(DATES_COL).doc(monthKey);
      const snap = await docRef.get();
      if(!snap.exists){
        return [];
      }
      const data = snap.data();
      return Array.isArray(data.dates) ? data.dates.slice().sort() : [];
    }

    async function saveDatesForMonth(monthKey, dates){
      await db.collection(DATES_COL).doc(monthKey).set({
        dates: dates
      }, { merge:true });
    }

    async function loadPersonAttendance(monthKey, name){
      if(!monthKey || !name) return {};
      const snap = await db.collection(ATT_COL)
        .where("month","==",monthKey)
        .where("name","==",name)
        .get();
      const result = {};
      snap.forEach(doc=>{
        const data = doc.data();
        if(data.date){
          result[data.date] = data.status || "unknown";
        }
      });
      return result;
    }

    async function savePersonAttendance(monthKey, name, statusByDate){
      const batch = db.batch();
      Object.entries(statusByDate).forEach(([date,status])=>{
        const docId = `${date}_${name}`;
        const ref = db.collection(ATT_COL).doc(docId);
        batch.set(ref,{
          month: monthKey,
          date: date,
          name: name,
          group: findGroupByName(name),
          status: status,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      });
      await batch.commit();
    }

    async function loadAttendanceByDate(dateStr){
      const snap = await db.collection(ATT_COL)
        .where("date","==",dateStr)
        .get();
      const list=[];
      snap.forEach(doc=>list.push(doc.data()));
      return list;
    }

    // ===== UI ë Œë”ë§ =====

    function renderDateChips(monthKey){
      const label = document.getElementById("currentMonthLabel");
      if(monthKey){
        const [y,m] = monthKey.split("-");
        label.textContent = `${y}ë…„ ${m}ì›” íŠ¹ê·¼ ë‚ ì§œ`;
      }else{
        label.textContent = "íŠ¹ê·¼ ì›”ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.";
      }

      const area = document.getElementById("dateListArea");
      area.innerHTML = "";
      if(!monthKey){
        area.textContent = "íŠ¹ê·¼ ì›”ì„ ì„ íƒí•˜ë©´ ì´ê³³ì— ë‚ ì§œê°€ í‘œì‹œë©ë‹ˆë‹¤.";
        return;
      }

      if(!currentMonthDates.length){
        area.textContent = "ë“±ë¡ëœ íŠ¹ê·¼ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      const wrap = document.createElement("div");
      wrap.className = "chip-wrap";

      currentMonthDates.forEach(dateStr=>{
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = formatDisplayDate(dateStr);

        const btn = document.createElement("button");
        btn.textContent = "Ã—";
        btn.addEventListener("click", ()=>{
          currentMonthDates = currentMonthDates.filter(d=>d!==dateStr);
          renderDateChips(monthKey);
          fillSummaryDateSelect();
          refreshPersonStatusArea();
        });

        chip.appendChild(btn);
        wrap.appendChild(chip);
      });

      area.appendChild(wrap);
    }

    function fillSummaryDateSelect(){
      const sel = document.getElementById("summaryDateSelect");
      sel.innerHTML = "";
      if(!currentMonthDates.length){
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "íŠ¹ê·¼ ë‚ ì§œ ì—†ìŒ";
        sel.appendChild(opt);
        return;
      }
      currentMonthDates.slice().sort().forEach(d=>{
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = formatDisplayDate(d) + " (" + d + ")";
        sel.appendChild(opt);
      });
    }

    async function refreshPersonStatusArea(){
      const area = document.getElementById("personStatusArea");
      area.innerHTML = "";
      const monthKey = getCurrentMonthValue();
      const name = document.getElementById("personSelect").value;

      if(!monthKey){
        area.innerHTML = '<div class="info">ë¨¼ì € ìœ„ì—ì„œ íŠ¹ê·¼ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
        return;
      }
      if(!currentMonthDates.length){
        area.innerHTML = '<div class="info">ì´ ì›”ì—ëŠ” ì•„ì§ ë“±ë¡ëœ íŠ¹ê·¼ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ìì—ì„œ ì¶”ê°€ í›„ ì‚¬ìš©)</div>';
        return;
      }
      if(!name){
        area.innerHTML = '<div class="info">ì´ë¦„ì„ ì„ íƒí•˜ë©´ ë‚ ì§œë³„ë¡œ ì°¸ì—¬ ì—¬ë¶€ë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
        return;
      }

      const statusMap = await loadPersonAttendance(monthKey, name);

      currentMonthDates.slice().sort().forEach(dateStr=>{
        const div = document.createElement("div");
        div.className = "status-group";

        const title = document.createElement("div");
        title.className = "status-title";
        title.textContent = formatDisplayDate(dateStr) + " / " + dateStr;
        div.appendChild(title);

        const options = document.createElement("div");
        options.className = "status-options";

        const currentStatus = statusMap[dateStr] || "unknown";
        const nameBase = "status_" + dateStr;

        const makeRadio = (value, labelText) => {
          const lbl = document.createElement("label");
          const input = document.createElement("input");
          input.type = "radio";
          input.name = nameBase;
          input.value = value;
          if(currentStatus === value) input.checked = true;
          lbl.appendChild(input);
          lbl.appendChild(document.createTextNode(labelText));
          return lbl;
        };

        options.appendChild(makeRadio("yes","ì°¸ì—¬"));
        options.appendChild(makeRadio("no","ë¶ˆì°¸"));
        options.appendChild(makeRadio("unknown","ë¯¸ì •"));

        div.appendChild(options);
        area.appendChild(div);
      });
    }

    async function handleSavePerson(){
      const monthKey = getCurrentMonthValue();
      const name = document.getElementById("personSelect").value;
      const msg = document.getElementById("personMsg");
      msg.textContent = "";

      if(!monthKey){
        msg.textContent = "íŠ¹ê·¼ ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
      }
      if(!name){
        msg.textContent = "ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
      }
      if(!currentMonthDates.length){
        msg.textContent = "ì´ ì›”ì—ëŠ” íŠ¹ê·¼ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ì„œ ë¨¼ì € ë‚ ì§œë¥¼ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.";
        return;
      }

      const statusByDate = {};
      currentMonthDates.forEach(dateStr=>{
        const radios = document.querySelectorAll(`input[name="status_${dateStr}"]`);
        let v = "unknown";
        radios.forEach(r=>{ if(r.checked) v = r.value; });
        statusByDate[dateStr] = v;
      });

      try{
        await savePersonAttendance(monthKey, name, statusByDate);
        msg.textContent = "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
        setTimeout(()=>{ msg.textContent=""; },2000);
      }catch(e){
        console.error(e);
        msg.textContent = "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    async function handleSummary(){
      const monthKey = getCurrentMonthValue();
      const dateStr = document.getElementById("summaryDateSelect").value;
      const group = document.getElementById("summaryGroupSelect").value;
      const box = document.getElementById("summaryResult");
      box.style.display = "block";
      box.innerHTML = "";

      if(!monthKey){
        box.textContent = "íŠ¹ê·¼ ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
      }
      if(!dateStr){
        box.textContent = "íŠ¹ê·¼ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ì„œ ë¨¼ì € ë‚ ì§œë¥¼ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.";
        return;
      }

      const allAttendance = await loadAttendanceByDate(dateStr);

      let targetPeople;
      if(group === "all"){
        targetPeople = people;
      }else{
        targetPeople = people.filter(p=>p.group===group);
      }

      const statusMap = {};
      allAttendance.forEach(item=>{
        statusMap[item.name] = item.status || "unknown";
      });

      const yesList = [];
      const noList = [];
      const unknownList = [];

      targetPeople.forEach(p=>{
        const s = statusMap[p.name] || "unknown";
        if(s==="yes") yesList.push(p);
        else if(s==="no") noList.push(p);
        else unknownList.push(p);
      });

      if(group === "all"){
        const total = targetPeople.length;
        const yesCnt = yesList.length;
        const noCnt = noList.length;
        const unkCnt = unknownList.length;
        const rate = total>0 ? ((yesCnt/total)*100).toFixed(1) : "0.0";

        let html = "";
        html += `<div class="summary-title">${dateStr} ${formatKoreanWeekday(dateStr)} / ì „ì²´</div>`;
        html += `<div>ì´ì›: ${total}ëª… Â· ì°¸ì—¬: ${yesCnt}ëª… Â· ë¶ˆì°¸: ${noCnt}ëª… Â· ë¯¸ì‘ë‹µ: ${unkCnt}ëª…</div>`;
        html += `<div>ì°¸ì—¬ìœ¨: <b>${rate}%</b></div>`;

        html += renderSummaryLists(yesList, noList, unknownList, true);
        box.innerHTML = html;
      }else{
        let html = "";
        html += `<div class="summary-title">${dateStr} ${formatKoreanWeekday(dateStr)} / ${group}</div>`;
        html += renderSummaryLists(yesList, noList, unknownList, false);
        box.innerHTML = html;
      }
    }

    function renderSummaryLists(yesList, noList, unknownList, showGroup){
      const nameFormat = p => showGroup ? `${p.name} (${p.group})` : p.name;

      const renderOne = (title, list, emoji, color) => {
        const names = list.map(nameFormat);
        const count = list.length;
        let inner = `<div style="margin-top:8px;"><b style="color:${color};">${emoji} ${title} (${count}ëª…)</b></div>`;
        if(!count){
          inner += `<div class="list-names empty">ì—†ìŒ</div>`;
        }else{
          inner += `<div class="list-names">${names.join(", ")}</div>`;
        }
        return inner;
      };

      let html = "";
      html += renderOne("ì°¸ì—¬", yesList, "âœ…", "#0a8a43");
      html += renderOne("ë¶ˆì°¸", noList, "âŒ", "#c00");
      html += renderOne("ë¯¸ì‘ë‹µ", unknownList, "â“", "#555");
      return html;
    }

    function handleAddDate(){
      const monthKey = getCurrentMonthValue();
      const input = document.getElementById("newDateInput");
      const msg = document.getElementById("dateMsg");
      msg.textContent = "";

      const v = input.value;
      if(!monthKey){
        msg.textContent = "ë¨¼ì € íŠ¹ê·¼ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
      }
      if(!v){
        msg.textContent = "ì¶”ê°€í•  ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
      }
      if(v.substring(0,7)!==monthKey){
        msg.textContent = "ì„ íƒí•œ ì›”ê³¼ ê°™ì€ ë‹¬ì˜ ë‚ ì§œë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
        return;
      }
      if(currentMonthDates.includes(v)){
        msg.textContent = "ì´ë¯¸ ë“±ë¡ëœ ë‚ ì§œì…ë‹ˆë‹¤.";
        return;
      }
      currentMonthDates.push(v);
      currentMonthDates.sort();
      input.value = "";
      renderDateChips(monthKey);
      fillSummaryDateSelect();
      refreshPersonStatusArea();
    }

    // ì„ íƒí•œ ì›”ì˜ ëª¨ë“  í† ìš”ì¼ ìë™ ì¶”ê°€
    function handleAutoSaturday(){
      const monthKey = getCurrentMonthValue();
      const msg = document.getElementById("dateMsg");
      msg.textContent = "";

      if(!monthKey){
        msg.textContent = "ë¨¼ì € íŠ¹ê·¼ ì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
      }

      const parts = monthKey.split("-");
      if(parts.length !== 2){
        msg.textContent = "ì›” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        return;
      }

      const year  = parseInt(parts[0], 10);
      const month = parseInt(parts[1], 10) - 1; // JS: 0=1ì›”
      if(isNaN(year) || isNaN(month)){
        msg.textContent = "ì›” ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        return;
      }

      // í•´ë‹¹ ì›”ì˜ ëª¨ë“  í† ìš”ì¼ ì°¾ê¸°
      const saturdays = [];
      let d = new Date(year, month, 1);
      while(d.getMonth() === month){
        if(d.getDay() === 6){ // 6 = í† ìš”ì¼
          const iso = d.getFullYear() + "-" +
                      pad2(d.getMonth()+1) + "-" +
                      pad2(d.getDate());
          saturdays.push(iso);
        }
        d.setDate(d.getDate() + 1);
      }

      // ê¸°ì¡´ ë‚ ì§œ + í† ìš”ì¼ ë‚ ì§œ í•©ì¹˜ê³  ì¤‘ë³µ ì œê±°
      const set = new Set(currentMonthDates);
      saturdays.forEach(dateStr => set.add(dateStr));
      currentMonthDates = Array.from(set).sort();

      // í™”ë©´ ê°±ì‹ 
      renderDateChips(monthKey);
      fillSummaryDateSelect();
      refreshPersonStatusArea();

      msg.textContent = "ì´ ì›”ì˜ í† ìš”ì¼ì„ ìë™ìœ¼ë¡œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ 'ì´ ì›”ì˜ íŠ¹ê·¼ ì„¤ì • ì €ì¥' ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì •í•´ì£¼ì„¸ìš”.";
    }

    async function handleSaveDates(){
      const monthKey = getCurrentMonthValue();
      const msg = document.getElementById("dateMsg");
      msg.textContent = "";

      if(!monthKey){
        msg.textContent = "íŠ¹ê·¼ ì›”ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
      }
      try{
        await saveDatesForMonth(monthKey, currentMonthDates.slice().sort());
        msg.textContent = "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
        setTimeout(()=>{ msg.textContent=""; },2000);
      }catch(e){
        console.error(e);
        msg.textContent = "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    async function updateAllForMonth(){
      const monthKey = getCurrentMonthValue();
      if(!monthKey){
        currentMonthDates = [];
        renderDateChips(null);
        fillSummaryDateSelect();
        refreshPersonStatusArea();
        return;
      }
      currentMonthDates = await loadDatesForMonth(monthKey);
      renderDateChips(monthKey);
      fillSummaryDateSelect();
      refreshPersonStatusArea();
    }

    function initMonthSelectDefault(){
      const now = new Date();
      const m = `${now.getFullYear()}-${pad2(now.getMonth()+1)}`;
      document.getElementById("monthSelect").value = m;
    }

    function initPeopleSelect(){
      const sel = document.getElementById("personSelect");
      const sorted = [...people].sort((a,b)=>a.name.localeCompare(b.name,"ko-KR"));
      sorted.forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p.name;
        opt.textContent = `${p.name} (${p.group})`;
        sel.appendChild(opt);
      });
    }

    function initEvents(){
      document.getElementById("monthSelect").addEventListener("change", updateAllForMonth);
      document.getElementById("personSelect").addEventListener("change", refreshPersonStatusArea);
      document.getElementById("savePersonBtn").addEventListener("click", ()=>{ handleSavePerson(); });
      document.getElementById("summaryBtn").addEventListener("click", ()=>{ handleSummary(); });
      document.getElementById("addDateBtn").addEventListener("click", ()=>{ handleAddDate(); });
      document.getElementById("autoSatBtn").addEventListener("click", ()=>{ handleAutoSaturday(); });
      document.getElementById("saveDatesBtn").addEventListener("click", ()=>{ handleSaveDates(); });
    }

    window.addEventListener("DOMContentLoaded", async ()=>{
      initPeopleSelect();
      initMonthSelectDefault();
      initEvents();
      await updateAllForMonth();
    });
  </script>
</body>
</html>

